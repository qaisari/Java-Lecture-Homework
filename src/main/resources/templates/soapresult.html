<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOAP Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { overflow-x: hidden; }
        #wrapper { display: flex; width: 100%; }
        #sidebar-wrapper { min-height: 100vh; width: 15rem; background-color: #f8f9fa; margin-left: -15rem; transition: margin 0.25s ease-out; }
        #sidebar-wrapper .sidebar-heading { padding: 0.875rem 1.25rem; font-size: 1.2rem; font-weight: bold; color: #333; }
        #sidebar-wrapper .list-group { width: 15rem; }
        .list-group-item { border: none; padding: 1rem 1.5rem; color: #495057; text-decoration: none; transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out; }
        .list-group-item:hover { background-color: #e9ecef; color: #0d6efd; }
        .list-group-item.active { background-color: #0d6efd; color: white; }
        #page-content-wrapper { width: 100%; min-height: 100vh; }
        body.sb-sidenav-toggled #sidebar-wrapper { margin-left: 0; }
        @media (min-width: 768px) {
            #sidebar-wrapper { margin-left: 0; }
            #page-content-wrapper { width: 100%; }
            body.sb-sidenav-toggled #sidebar-wrapper { margin-left: -15rem; }
        }
        .navbar-custom { background-color: #fff; border-bottom: 1px solid #dee2e6; padding: 1rem; }
        .content { padding: 2rem; }

        /* Results page styles */
        .chart-card { padding: 1rem; border-radius: 0.5rem; box-shadow: 0 6px 18px rgba(2,6,23,0.04); }
        /* make chart fluid within the content column and centered */
        .chart-container { width: 100%; max-width: 760px; height: 380px; margin: 0 auto; }
        .chart-container canvas { width: 100% !important; height: 100% !important; display: block; }
        .small-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace; font-size: 0.95rem; }
    </style>
</head>
<body>
<div id="wrapper">
    <!-- Sidebar -->
    <div id="sidebar-wrapper">
        <div class="sidebar-heading">Student Management</div>
        <div class="list-group list-group-flush">
            <span>
                <a th:href="@{/home}" class="list-group-item list-group-item-action">Home</a>
            </span>
            <span>
                <a th:href="@{/soap}" class="list-group-item list-group-item-action active">SOAP</a>
            </span>
        </div>
    </div>

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <nav class="navbar-custom d-flex justify-content-between align-items-center">
            <button class="btn btn-primary" id="sidebarToggle">Toggle Menu</button>
            <h1 class="mb-0">Dashboard</h1>
        </nav>

        <div class="content container">
            <div class="row">
                <div class="col-lg-8">
                    <h2>Historical prices:</h2>

                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Summary</h5>
                            <!-- show a short summary (everything before the first '<') so the full XML doesn't appear inline -->
                            <p class="card-text small-mono" th:if="${sendOut != null}" th:text="${#strings.substringBefore(sendOut,'<')}"></p>
                            <p class="card-text small-mono" th:unless="${sendOut != null}"></p>
                            <p class="text-muted">Below you'll find a chart and the raw data returned by the SOAP service.</p>
                        </div>
                    </div>

                    <div class="card chart-card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Exchange Rate Chart</h5>
                            <div class="chart-container mt-3">
                                <canvas id="myChart"></canvas>
                            </div>
                            <!-- Debug: collapsed JSON of inlined arrays (use this to verify server data) -->
                            <p class="mt-2">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#debugData" aria-expanded="false">Toggle debug data</button>
                            </p>
                            <div class="collapse" id="debugData">
                                <pre class="small-mono bg-dark text-white p-3" id="debugJson">(loading...)</pre>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Data points</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Rate</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="date, iter : ${dates}">
                                        <td th:text="${date}"></td>
                                        <td th:text="${values[iter.index]}"></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Raw SOAP response</h5>
                            <p class="text-muted">(collapsed by default)</p>
                            <button class="btn btn-sm btn-outline-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#rawXml" aria-expanded="false" aria-controls="rawXml">Toggle raw XML</button>
                            <div class="collapse" id="rawXml">
                                <pre class="small-mono bg-light p-3" th:text="${sendOut}"></pre>
                            </div>
                        </div>
                    </div>

                    <a th:href="@{/soap}" class="btn btn-link">Back to the form</a>
                </div>

                <div class="col-lg-4">
                    <div class="card position-sticky" style="top:1rem;">
                        <div class="card-body">
                            <h5 class="card-title">Tips</h5>
                            <ul>
                                <li>Pick a range of 1–30 days for clearer charts.</li>
                                <li>Use `EUR` or major currencies to avoid sparse data.</li>
                                <li>Click on the data table header to sort (not implemented — next step).</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js and initialization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    var labels = /*[[${dates}]]*/ [];
    var rawValues = /*[[${values}]]*/ [];
    /*]]>*/

    // Normalize
    labels = labels || [];
    rawValues = rawValues || [];

    document.addEventListener('DOMContentLoaded', function() {
        // Show debug JSON in the collapsed panel
        try {
            var debugEl = document.getElementById('debugJson');
            if (debugEl) debugEl.textContent = JSON.stringify({labels: labels, values: rawValues}, null, 2);
        } catch (e) { /* ignore */ }

        // Parse numeric values (support comma decimals)
        var parsedValues = (rawValues || []).map(function(v){ return Number(('' + v).replace(',', '.')) || 0; });

        function createChart(theLabels, theValues) {
            // reverse to earliest-first
            var l = (theLabels || []).slice().reverse();
            var v = (theValues || []).slice().reverse();

            var minVal = v.length ? Math.min.apply(null, v) : 0;
            var maxVal = v.length ? Math.max.apply(null, v) : 1;
            var padding = (maxVal - minVal) * 0.12;
            if (padding === 0) padding = Math.max(1, maxVal * 0.08);
            var suggestedMin = Math.max(0, minVal - padding);
            var suggestedMax = maxVal + padding;

            try {
                var canvas = document.getElementById('myChart');
                var ctx = canvas.getContext('2d');

                if (window._soapChart) {
                    try { window._soapChart.destroy(); } catch(e){}
                    window._soapChart = null;
                }

                window._soapChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: l,
                        datasets: [{
                            label: 'Exchange Rate',
                            data: v,
                            borderWidth: 1.8,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13,110,253,0.06)',
                            tension: 0.24,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                        interaction: { mode: 'nearest', axis: 'x', intersect: false },
                        scales: {
                            x: { ticks: { maxRotation: 45, minRotation: 0, autoSkip: true } },
                            y: { beginAtZero: false, suggestedMin: suggestedMin, suggestedMax: suggestedMax }
                        }
                    }
                });
            } catch (err) {
                console.error('Chart creation error:', err);
                var container = document.querySelector('.chart-container');
                if (container) container.innerHTML = '<div class="p-3 text-danger">Error rendering chart. Open console for details.</div>';
            }
        }

        if (!labels.length || !parsedValues.length) {
            // show friendly message when there's no data and provide a sample-data button for testing
            var container = document.querySelector('.chart-container');
            if (container) {
                container.innerHTML = '<div class="p-4 text-center text-muted">No data available for the selected range.<br><button id="loadSample" class="btn btn-sm btn-outline-primary mt-2">Load sample data</button></div>';
                var btn = document.getElementById('loadSample');
                if (btn) {
                    btn.addEventListener('click', function() {
                        // sample data (chronological)
                        var sampleLabels = ['2025-11-01','2025-11-02','2025-11-03','2025-11-04'];
                        var sampleValues = [383.5, 385.2, 384.1, 386.0];
                        createChart(sampleLabels, sampleValues);
                    });
                }
            }
            return;
        }

        // All good: render chart with real data
        createChart(labels, parsedValues);
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const toggleBtn = document.getElementById('sidebarToggle');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            document.body.classList.toggle('sb-sidenav-toggled');
        });
    }
</script>
</body>
</html>